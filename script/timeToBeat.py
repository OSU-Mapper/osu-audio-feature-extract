#python timeToBeat.py "Daisuke Achiwa - BASARA (Willian Zhang) [test-beat].osu" "tmp.csv"
import sys
import argparse
import numpy as np
import csv
def search(input, file):
    hitobject = []
    with open(file, 'r') as my_file:
        csvreader = csv.reader(my_file)
        find = False
        target = "[" + input + "]"
        for line in csvreader:
            if target in line:
                find = True
                break
        if (find):
            for tmp in csvreader:
                if len(tmp) != 0:
                    if len(tmp) == 5:
                        tmp = list(map(int, tmp))
                        for i in range(4):
                            tmp.append(0)
                    else:
                        lastele = tmp[len(tmp)-1]
                        tmp = tmp[0:5]
                        tmp = list(map(int, tmp))
                        addition = lastele.split(":")
                        if len(addition) == 4:
                            for i in range(4):
                                tmp.append(int(addition[i]))
                        else:
                            for i in range(4):
                                tmp.append(0)
                    hitobject.append(tmp)
                else: 
                    break	
            return hitobject	
        else:
            print("No such infomation in file")

def getbeat(input):
    beats = []
    with open(input, 'r') as my_file:
        csvreader = csv.reader(my_file)
        for line in csvreader:
            line = list(map(float, line))
            beats.append(line)
    return beats

# def closestindex(x, y):
#     for i in range(len(y)):
#         if y[i][1] == x:
#             return i
#         elif y[i][1] > x:
#             if i == 0:
#                 return i
#             elif abs(y[i][1] - x) <= abs(y[i-1][1] - x):
#                 return i
#             else:
#                 return i - 1
#     if i == len(y) - 1:
#         return i


# def merge(x, y):
#     print (len(x))
#     print (len(y))
#     feature_copy = y
#     for i in range(len(x)):
#         index = closestindex(x[i][2], y)
#         if len(feature_copy[index]) == 3:
#             tmp = x[i]
#             tmp[2] = int(y[index][1]) 
#             # print (tmp[2])
#             tmp[3] = 1
#             feature_copy[index] = [int(y[index][0])] + tmp + [y[index][2]]
#     for i in range(len(feature_copy)):
#         if len(feature_copy[i]) == 3:
#             feature_copy[i] = [int(y[i][0]),0,0,int(y[i][1]),0,0,0,0,0,0,y[i][2]]
#     return feature_copy


def closestindex(x, y):
    for i in range(len(y)):
        if y[i] == x:
            return i
        elif y[i] > x:
            if i == 0 or abs(y[i] - x) <= abs(y[i-1] - x):
                return i
            else:
                return i - 1
    if i == len(y) - 1:
        return i

def merge(x, y):
    # x = [1000 * e for e in x]
    feature_copy = y
    startindex = 0
    for i in range(len(x)):
        index = closestindex(x[i], y)
        if len(feature_copy[index + startindex]) == 4:
            feature_copy[index + startindex] = (feature_copy[index + startindex][0], feature_copy[index + startindex][1], feature_copy[index + startindex][2], feature_copy[index + startindex][3], 1) 
        startindex += index
        y = y[index:]
    for i in range(len(feature_copy)):
        if len(feature_copy[i]) == 4:
            feature_copy[i] = (feature_copy[i][0], feature_copy[i][1], feature_copy[i][2], feature_copy[i][3], 0)
    return feature_copy


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print( "usage: inputfile outputfile")
        raise argparse.ArgumentTypeError('the number of argument has to be 3')
        exit(-1)
    filePath = sys.argv[1]
    csvPath  = sys.argv[2]
    hitobject = search("HitObjects", filePath)
    # beats = getbeat(csvPath)
    beats = [3115.827664399093, 3361.0884353741499, 3478.6394557823132, 3591.8367346938776, 3687.6190476190477, 3813.8775510204082, 3935.7823129251701, 4051.8820861678009, 4208.6167800453513, 4281.1791383219952, 4387.1201814058959, 4498.8662131519277, 4729.614512471655, 4966.1678004535142, 5211.4285714285716, 5323.1746031746034, 5436.3718820861677, 5555.3741496598641, 5671.4739229024945, 5787.5736961451248, 5897.8684807256241, 6118.4580498866217, 6231.655328798186, 6353.5600907029484, 6474.0136054421764, 6582.8571428571431, 6694.603174603174, 6812.1541950113378, 7047.2562358276637, 7173.5147392290246, 7286.7120181405899, 7520.3628117913831, 7633.5600907029475, 7759.8185941043084, 8000.7256235827672, 8227.120181405895, 8457.868480725625, 8575.419501133787, 8659.5918367346949, 8922.2675736961446, 9025.3061224489793, 9157.3696145124723, 9261.8594104308395, 9367.8004535147393, 9607.2562358276646, 9721.9047619047615, 9819.138321995466, 9920.7256235827663, 10046.984126984127, 10293.696145124717, 10505.578231292517, 10771.156462585035, 10968.526077097506, 11209.433106575963, 11434.37641723356, 11662.222222222223, 11892.970521541951, 12128.072562358277, 12357.369614512472, 12583.764172335601, 12707.120181405897, 12814.512471655329, 13055.419501133787, 13277.460317460318, 13508.208616780046, 13738.956916099774, 13972.607709750568, 14200.453514739229, 14438.458049886622, 14553.106575963719, 14660.498866213151, 14924.625850340137, 15032.018140589569, 15126.349206349205, 15383.219954648526, 15474.648526077097, 15584.943310657596, 15834.557823129253, 16049.342403628118, 16515.192743764172, 17201.632653061224, 17432.380952380954, 17664.580498866213, 17898.231292517008, 18361.179138321993, 18583.219954648528, 18825.578231292518, 19049.070294784582, 19162.267573696146, 19272.562358276646, 19501.859410430839, 19736.961451247163, 19974.96598639456, 20201.360544217685, 20440.816326530614, 20555.464852607711, 20662.857142857141, 20890.702947845806, 21011.156462585033, 21124.353741496598, 21356.55328798186, 21587.30158730159, 21816.598639455784, 21948.662131519275, 22047.34693877551, 22291.156462585033, 22534.965986394556, 22970.340136054423, 23433.287981859412, 23666.938775510203, 23794.648526077097, 23893.333333333336, 24144.399092970521, 24356.281179138321, 24595.736961451246, 24816.326530612245, 25071.746031746032, 25279.274376417234, 25745.124716553288, 26209.523809523809, 26662.312925170067, 27126.712018140592, 27358.911564625851, 27586.757369614512, 28048.253968253968, 28508.299319727888, 28972.698412698413, 29206.349206349205, 29432.743764172337, 29673.650793650795, 29892.789115646261, 30133.696145124715, 30354.285714285717, 30608.253968253968, 30818.684807256235, 31050.884353741498, 31278.730158730159, 31515.283446712019, 31741.678004535144, 31970.975056689345, 32201.723356009068, 32433.922902494331, 32548.571428571428, 32664.671201814061, 33129.070294784586, 33352.562358276642, 33477.36961451247, 33593.469387755096, 33818.4126984127, 33931.609977324268, 34043.356009070296, 34271.201814058957, 34506.303854875281, 34742.857142857138, 34969.251700680274, 35210.158730158735, 35324.807256235828, 35439.455782312929, 35660.045351473927, 35777.596371882086, 35893.696145124712, 36124.444444444445, 36355.192743764172, 36588.843537414963, 36716.553287981857, 36819.591836734697, 37054.693877551021, 37285.442176870747, 37739.682539682537, 38201.179138321997, 38434.829931972788, 38562.539682539682, 38665.578231292515, 38912.290249433107, 39131.428571428572, 39363.628117913831, 39585.668934240362, 39839.637188208617, 40047.165532879815, 40513.015873015873, 40977.414965986398, 41431.655328798188, 41896.054421768713, 42357.551020408166, 42823.401360544216, 43279.092970521539, 43740.589569160999, 43975.691609977323, 44203.537414965984, 44914.648526077093, 45125.079365079364, 45599.637188208617, 46049.523809523809, 46515.37414965986, 46971.065759637189, 47203.265306122448, 47320.816326530614, 47434.013605442175, 47896.961451247167, 48357.006802721087, 48818.503401360547, 49044.897959183669, 49280.0, 49500.589569160999, 49742.947845804993, 49870.657596371886, 49970.793650793654, 50202.993197278913, 50430.839002267574, 50665.941043083898, 50774.784580498868, 50892.335600907034, 51124.535147392293, 51587.482993197278, 51800.816326530614, 52048.979591836731, 52279.727891156464, 52509.024943310658, 52635.283446712019, 52738.321995464852, 52971.972789115644, 53191.111111111109, 53433.469387755104, 53562.63038548753, 53667.120181405902, 53896.417233560096, 54121.360544217685, 54363.718820861679, 54468.208616780044, 54584.308390022677, 54815.056689342404, 55280.907029478454, 55516.009070294785, 55740.952380952382, 56202.448979591834, 56430.294784580496, 56663.945578231294, 56885.986394557825, 57125.442176870747, 57253.151927437641, 57359.092970521546, 57586.938775510207, 57814.784580498868, 58054.24036281179, 58160.181405895695, 58276.281179138321, 58509.93197278912, 58971.428571428565, 59200.725623582766, 59432.925170068025, 59646.258503401361, 59897.32426303855, 60123.718820861679, 60357.36961451247, 60575.056689342404, 60817.414965986398, 61051.065759637189, 61276.009070294785, 61509.659863945577, 61738.956916099771, 61971.156462585037, 62200.453514739231, 62666.303854875281, 63129.251700680274, 63589.297052154194, 63815.691609977323, 64047.891156462581, 64280.090702947848, 64512.290249433107, 64741.5873015873, 64975.238095238099, 65198.730158730155, 65435.283446712019, 65544.126984126997, 65661.678004535148, 65893.877551020414, 66356.825396825399, 66578.866213151923, 66821.224489795917, 67278.367346938772, 67507.664399092973, 67742.766439909305, 67959.002267573698, 68202.811791383225, 68435.011337868476, 68665.759637188195, 68895.056689342397, 69130.158730158728, 69355.102040816317, 69585.85034013605, 70051.700680272101, 70513.197278911568, 70973.242630385488, 71199.63718820861, 71433.287981859408, 71664.036281179142, 71896.235827664394, 72022.494331065755, 72126.984126984127, 72357.732426303861, 72591.383219954645, 72822.131519274379, 72928.072562358284, 73047.074829931968, 73277.823129251701, 73740.770975056686, 73974.421768707485, 74205.170068027219, 74669.569160997737, 74891.60997732426, 75128.163265306124, 75356.009070294793, 75588.208616780044, 75817.505668934245, 76051.15646258503, 76281.904761904749, 76512.653061224482, 76631.655328798195, 76859.501133786849, 76974.149659863935, 77431.292517006805, 77669.297052154187, 77897.142857142855, 78129.342403628121, 78245.442176870754, 78354.28571428571, 78593.741496598639, 78817.233560090695, 79046.530612244896, 79277.278911564616, 79741.678004535148, 79975.328798185947, 80091.428571428565, 80200.272108843536, 80664.671201814053, 80892.517006802722, 81123.265306122456, 81362.721088435384, 81587.664399092973, 81821.315192743772, 81937.414965986391, 82047.709750566893, 82285.71428571429, 82510.657596371879, 82739.95464852608, 82970.702947845813, 83435.102040816331, 83892.244897959186, 84131.700680272101, 84241.995464852604, 84363.900226757367, 84816.689342403639, 85281.088435374142, 85513.287981859408, 85627.936507936509, 85738.231292516997, 85977.687074829926, 86201.179138321997, 86430.476190476184, 86662.67573696145, 87127.074829931968, 87359.274376417234, 87475.374149659867, 87584.217687074823, 88050.068027210888, 88276.462585034009, 88508.662131519275, 88973.061224489793, 89205.260770975059, 89321.360544217678, 89431.655328798181, 89894.60317460318, 90125.351473922899, 90354.648526077101, 90821.950113378683, 91049.795918367352, 91165.895691609971, 91283.446712018151, 91515.646258503388, 91742.040816326538, 92200.634920634926, 92444.444444444438, 92665.034013605429, 92897.233560090695, 93013.333333333328, 93123.628117913846, 93361.632653061228, 93588.027210884349, 93815.873015873003, 94045.170068027204, 94509.569160997722, 94741.768707482988, 94859.319727891168, 94969.614512471657, 95434.013605442175, 95661.859410430829, 95892.607709750562, 96357.006802721095, 96589.206349206346, 96819.95464852608, 97278.548752834467, 97507.845804988669, 97740.04535147392, 98202.99319727892, 98435.192743764172, 98551.292517006805, 98663.03854875284, 98901.043083900222, 99015.691609977323, 99133.242630385488, 99587.482993197278, 99829.841269841272, 100048.97959183675, 100282.63038548752, 100511.92743764172, 100745.57823129251, 100971.97278911564, 101432.01814058956, 101894.96598639456, 102127.16553287981, 102241.81405895692, 102357.91383219954, 102823.76417233561, 103278.00453514738, 103743.85487528345, 103973.15192743765, 104089.25170068028, 104203.90022675737, 104437.55102040817, 104669.75056689343, 104901.95011337868, 105125.44217687075, 105356.19047619047, 105586.93877551021, 105820.58956916101, 105935.23809523809, 106052.78911564626, 106167.43764172336, 106283.53741496599, 106514.28571428572, 106972.87981859411, 107200.72562358277, 107328.43537414966, 107435.8276643991, 107666.57596371883, 107781.22448979592, 107888.61678004535, 108117.91383219954, 108353.01587301587, 108599.72789115646, 108815.96371882087, 109058.32199546485, 109174.42176870749, 109280.36281179138, 109505.30612244898, 109743.31065759636, 109968.25396825396, 110201.90476190476, 110432.65306122448, 110567.61904761905, 110663.40136054422, 110908.66213151928, 111589.2970521542, 112044.98866213151, 112285.89569160999, 112407.80045351473, 112509.38775510204, 112759.0022675737, 112975.23809523809, 113205.98639455783, 113435.28344671203, 113684.89795918367, 113899.68253968254, 114356.8253968254, 114821.22448979592, 115049.07029478459, 115279.81859410432, 115745.66893424036, 115979.31972789115, 116201.36054421769, 116665.7596371882, 116895.0566893424, 117127.25623582766, 117591.65532879818, 117823.85487528345, 118047.3469387755, 118289.7052154195, 118510.29478458049, 118752.6530612245, 118971.79138321996, 119222.85714285713, 119437.64172335601, 119674.19501133787, 119893.33333333333, 120147.30158730158, 120356.28117913833, 120594.28571428572, 120701.67800453515, 120819.22902494331, 120935.32879818593, 121167.5283446712, 121280.72562358277, 121742.22222222222, 121970.06802721089, 122096.32653061225, 122203.71882086169, 122434.46712018141, 122549.11564625851, 122657.95918367348, 122887.25623582766, 123122.35827664399, 123370.52154195012, 123586.75736961451, 123827.66439909297, 123942.31292517007, 124051.15646258503, 124274.6485260771, 124511.20181405895, 124739.04761904762, 124974.14965986394, 125201.9954648526, 125335.51020408163, 125432.74376417232, 125676.55328798186, 126355.73696145124, 126815.78231292516, 127053.78684807256, 127181.49659863945, 127277.27891156462, 127529.79591836734, 127743.12925170068, 127975.32879818595, 128204.62585034013, 128454.24036281179, 128667.57369614513, 129127.61904761905, 130047.70975056689, 130513.56009070296, 130747.21088435373, 130970.70294784581, 131433.6507936508, 131895.14739229027, 132359.54648526077, 132594.6485260771, 132707.84580498867, 132818.14058956917, 133281.08843537417, 133741.13378684808, 134206.98412698414, 134437.73242630385, 134669.93197278914, 135127.07482993198, 135587.12018140592, 135935.41950113379, 136051.51927437639, 136510.11337868482, 136737.95918367346, 136864.21768707485, 136974.51247165533, 137203.80952380953, 137318.45804988663, 137428.75283446713, 137655.14739229024, 137893.15192743763, 138129.7052154195, 138354.64852607707, 138595.55555555556, 138711.65532879817, 138821.95011337867, 139045.44217687074, 139279.09297052154, 139508.39002267574, 139742.04081632651, 139971.33786848074, 140103.4013605442, 140202.08616780044, 140442.99319727893, 140688.25396825396, 141125.07936507935, 141588.02721088435, 141821.67800453515, 141947.93650793651, 142046.62131519275, 142296.23582766438, 142511.02040816325, 142743.21995464855, 142972.51700680272, 143222.13151927438, 143319.36507936506, 143436.91609977325, 143894.05895691609, 144355.55555555556, 144586.3038548753, 144815.60090702947, 145281.45124716553, 145513.65079365077, 145740.04535147393, 146210.24943310657, 146430.83900226757, 146664.48979591837, 147127.43764172337, 147361.08843537414, 147586.03174603175, 147826.93877551021, 148047.52834467121, 148286.98412698411, 148509.02494331065, 148761.54195011337, 148971.97278911565, 149214.33106575964, 149432.01814058959, 149684.53514739231, 149897.86848072562, 150124.26303854876, 150356.46258503402, 150474.01360544216, 150701.85941043083, 150819.41043083902, 151283.80952380953, 151507.3015873016, 151633.56009070296, 151742.40362811793, 151973.15192743763, 152086.3492063492, 152199.54648526077, 152424.48979591837, 152662.49433106577, 152897.5963718821, 153123.99092970524, 153364.89795918367, 153594.19501133787, 153814.78458049888, 153932.33560090704, 154048.43537414965, 154279.18367346938, 154509.93197278911, 154740.68027210885, 154871.2925170068, 154974.33106575962, 155213.78684807257, 155457.5963718821, 155894.42176870749, 156355.91836734692, 156589.56916099775, 156717.27891156462, 156815.96371882086, 157062.67573696145, 157286.16780045352, 157518.36734693879, 157741.85941043083, 157991.47392290249, 158087.25623582766, 158204.80725623583, 158435.55555555556, 158563.26530612246, 158661.95011337867, 159039.27437641725, 159143.76417233562, 159584.9433106576, 160050.79365079364, 160512.29024943311, 160560.18140589568, 160885.26077097506, 160978.14058956917, 161433.83219954648, 161802.44897959183, 161895.32879818595, 162245.07936507935, 162355.37414965985, 162824.12698412698, 163279.81859410432, 164205.71428571429, 164565.62358276645, 164670.11337868482, 165127.25623582766, 165588.75283446713, 166051.70068027213, 166276.6439909297, 166401.45124716553, 166516.09977324263, 166742.49433106577, 166854.2403628118, 166968.88888888891, 167195.28344671201, 167431.83673469388, 167665.48752834467, 167896.23582766441, 168132.78911564627, 168247.43764172337, 168362.08616780044, 168582.67573696145, 168700.22675736962, 168816.32653061225, 169047.07482993198, 169277.82312925172, 169511.47392290249, 169639.18367346938, 169742.22222222222, 169975.87301587302, 170206.62131519272, 170662.31292517006, 171123.80952380953, 171357.46031746033, 171486.62131519272, 171588.20861678003, 171834.92063492062, 172054.05895691609, 172286.25850340136, 172508.29931972787, 172760.81632653059, 172969.79591836734, 173435.6462585034, 173900.04535147393, 174355.73696145124, 174818.68480725624, 175049.43310657598, 175280.18140589568, 175746.03174603175, 176200.27210884352, 176663.21995464852, 176898.32199546485, 177126.16780045352, 177364.17233560089, 177584.76190476189, 177824.21768707482, 178047.70975056689, 178300.22675736962, 178510.65759637189, 178739.95464852607, 178972.15419501133, 179205.80498866213, 179432.19954648527, 179554.10430839, 179673.10657596373, 179893.69614512473, 180011.2471655329, 180239.09297052154, 180356.6439909297, 180819.5918367347, 181045.98639455781, 181169.34240362814, 181283.99092970524, 181510.38548752834, 181622.13151927438, 181736.78004535148, 181967.52834467118, 182199.72789115648, 182433.37868480725, 182664.12698412698, 182902.13151927438, 183015.32879818595, 183129.97732426305, 183350.56689342402, 183469.56916099772, 183585.66893424038, 183814.96598639456, 184045.71428571429, 184280.81632653062, 184407.07482993198, 184510.11337868482, 184743.76417233559, 184975.96371882086, 185431.65532879817, 185891.7006802721, 186126.80272108843, 186255.96371882086, 186356.09977324263, 186602.81179138322, 186821.95011337867, 187054.14965986396, 187277.64172335601, 187530.15873015873, 187739.13832199544, 188204.98866213151, 188666.48526077098, 189123.62811791382, 189586.57596371882, 190048.07256235828, 190513.92290249432, 190971.06575963719, 191432.56235827663, 191674.92063492062, 191782.31292517006, 191894.05895691609, 192709.65986394556, 192818.50340136053, 193284.3537414966, 193510.7482993197, 193742.947845805, 194205.89569160997, 194664.48979591837, 195011.33786848071, 195133.2426303855, 195371.24716553287, 195482.99319727891, 195615.0566893424, 195719.54648526077, 195842.90249433107, 195947.39229024944, 196075.10204081633, 196202.81179138322, 196285.53287981858, 196538.0498866213, 196635.28344671201, 196747.02947845805, 196858.77551020408, 196913.92290249435, 196970.52154195012, 201007.8911564626, 201068.84353741497, 201125.44217687074]
    result = merge(hitobject, beats)
    with open("labeledFeature.csv", "w") as file:
        writer = csv.writer(file)
        writer.writerows(result)
    